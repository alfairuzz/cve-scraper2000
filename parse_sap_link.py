import re
import pandas as pd
from bs4 import BeautifulSoup

def get_sap_details(soup):
    """
    Extracts SAP security note details from the provided BeautifulSoup object.

    Parameters:
    soup (BeautifulSoup): The parsed HTML content of the SAP security notes page.

    Returns:
    pd.DataFrame: A DataFrame containing 'Note#', 'Title', 'CVE Number', 'Priority',
                  'CVSS', 'Product', 'Versions', and 'Impact' details.
    """
    print('Retrieving SAP Data...')

    # Find the first table in the HTML content
    table = soup.find('table')
    if not table:
        print("No tables found in the provided HTML content.")
        return pd.DataFrame()  # Return an empty DataFrame if no tables are found

    # Extract headers from the table
    headers = [th.get_text(strip=True) for th in table.find_all('th')]
    if len(headers) < 4:
        # Use default headers if extraction fails
        headers = ["Note#", "Title", "Priority", "CVSS"]

    # Initialize a list to store the extracted rows
    rows = []

    # Iterate over table rows, skipping the header row
    for row in table.find_all('tr')[1:]:
        cols = row.find_all('td')

        # Ensure there are enough columns to prevent IndexError
        if len(cols) < 4:
            continue  # Skip rows that don't have enough columns

        # Extract data from columns
        note_number = cols[0].get_text(strip=True)
        title_text = cols[1].get_text(separator=" ").strip()
        priority = cols[2].get_text(strip=True)
        cvss_score = cols[3].get_text(strip=True)

        # Find all CVE numbers in the title
        cve_matches = re.findall(r'CVE-\d{4}-\d{4,}', title_text)

        # If multiple CVEs are found, duplicate the row for each CVE
        if cve_matches:
            for cve_number in cve_matches:
                rows.append([note_number, title_text, cve_number, priority, cvss_score])
        else:
            # Handle cases where no CVE is found
            cve_number = 'N/A'
            rows.append([note_number, title_text, cve_number, priority, cvss_score])

    # Create a DataFrame from the extracted data
    df = pd.DataFrame(rows, columns=["Note#", "Title", "CVE Number", "Priority", "CVSS"])

    # Function to extract Product, Versions, and Impact from the Title
    def extract_product_version_impact(title):
        """
        Extracts Product, Versions, and Impact from the title string.

        Parameters:
        title (str): The title string containing the information.

        Returns:
        tuple: A tuple containing (product, versions, impact).
        """
        # Regular expression to capture Product and Versions information
        product_match = re.search(
            r'Product\s*[:-]\s*(.*?)\s*(?:Version|Versions)\s*[:-]\s*(.*?)\s*(?:Impact\s*[:-]\s*(.*))?$',
            title, re.IGNORECASE
        )

        if product_match:
            product = product_match.group(1).strip()
            versions = product_match.group(2).strip()
            impact = product_match.group(3).strip() if product_match.group(3) else 'N/A'
        else:
            product = 'N/A'
            versions = 'N/A'
            impact = 'N/A'

        return product, versions, impact

    # Apply the extraction function to the 'Title' column
    extracted_info = df['Title'].apply(extract_product_version_impact)
    df[['Product', 'Versions', 'Impact']] = pd.DataFrame(extracted_info.tolist(), index=df.index)

    # Clean up the 'Versions' and 'Impact' columns
    df['Versions'] = df['Versions'].str.replace(r'â€“\s*', '', regex=True).str.strip()
    df['Impact'] = df['Impact'].str.strip()

    return df
